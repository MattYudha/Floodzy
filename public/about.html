<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floodzy | The Early Warning System</title>
    <script>
        if (location.search.includes('force_intro')) {
            localStorage.removeItem('floodzy_seen');
        } else if (location.search.includes('mode=read')) {
            // Just render page, do nothing
        } else if (localStorage.getItem('floodzy_seen')) {
            document.documentElement.className = 'returning-visitor';
            window.addEventListener('DOMContentLoaded', () => {
                document.body.classList.add('returning-visitor');
                setTimeout(() => window.location.href = '/peta-banjir', 1500);
            });
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Outfit:wght@300;400;600;800&family=Space+Grotesk:wght@300;400;500;600;700&family=Playfair+Display+SC:wght@700;900&family=Black+Ops+One&display=swap"
        rel="stylesheet">

    <style>
        :root {
            /* Colors */
            --bg-void: #050507;
            --text-main: #E1E3E8;
            --text-muted: #9499A6;

            --cyan: #2EF2FF;
            --cyan-glow: rgba(46, 242, 255, 0.4);

            --red: #FF3B30;
            --red-glow: rgba(255, 59, 48, 0.4);

            /* Fonts */
            --font-disaster: 'Black Ops One', system-ui, sans-serif;
            --font-body: 'Space Grotesk', system-ui, sans-serif;
            --font-display: 'Outfit', system-ui, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;

            /* Z-Index Layers */
            --z-bg: 0;
            --z-rain: 5;
            --z-scene: 10;
            --z-water: 20;
            --z-ui: 50;
            --z-cursor: 100;
        }

        /* RESET */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            cursor: none;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background-color: var(--bg-void);
            color: var(--text-main);
            font-family: var(--font-body);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            transition: transform 0.1s;
        }

        /* CURSOR ACCESSIBILITY */
        @media (pointer: fine) {

            *,
            *::before,
            *::after {
                cursor: none;
            }
        }

        @media (pointer: coarse) {

            *,
            *::before,
            *::after {
                cursor: auto !important;
            }
        }

        /* MICRO SHAKE - FEATURE ADDITION (TONED DOWN) */
        body.failure {
            animation: micro-shake 0.6s infinite;
        }

        @keyframes micro-shake {
            0% {
                transform: translate(0, 0);
            }

            50% {
                transform: translate(1px, -1px);
            }

            100% {
                transform: translate(0, 0);
            }
        }

        /* CURSOR */
        #cursor-dot,
        #cursor-ring {
            position: fixed;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: var(--z-cursor);
            border-radius: 50%;
            display: none;
        }

        #cursor-dot {
            width: 6px;
            height: 6px;
            background: var(--cyan);
            box-shadow: 0 0 10px var(--cyan);
            transform: translate(-50%, -50%);
        }

        #cursor-ring {
            width: 40px;
            height: 40px;
            border: 1px solid var(--cyan-glow);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s, border-color 0.3s;
            will-change: transform;
        }

        body.sentinel-active #cursor-ring {
            width: 80px;
            height: 80px;
            border-color: transparent;
        }

        /* REDIRECT OVERLAY */
        #redirect-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--cyan);
            font-family: var(--font-mono);
        }

        body.returning-visitor #redirect-overlay {
            display: flex;
        }

        body.returning-visitor>*:not(#redirect-overlay) {
            display: none !important;
        }

        #cursor-ring::after {
            content: "";
            position: absolute;
            inset: -2px;
            border-radius: inherit;
            border: 2px dashed var(--red);
            opacity: 0;
            background: rgba(255, 59, 48, 0.05);
            transition: opacity .2s ease;
        }

        body.sentinel-active #cursor-ring::after {
            opacity: 1;
            animation: spin 4s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        @media (pointer: coarse) {

            *,
            *::before,
            *::after {
                cursor: auto !important;
            }

            #cursor-dot,
            #cursor-ring {
                display: none !important;
            }
        }

        /* FX CANVAS */
        #fx-canvas {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            z-index: 35;
            /* di atas rain & scene, di bawah HUD */
            pointer-events: none;
            opacity: 1;
        }

        /* SPLASH OVERLAY (air ke kamera) */
        #splash-overlay {
            position: fixed;
            inset: -10%;
            z-index: 40;
            pointer-events: none;
            opacity: 0;
            transform: scale(0.98);
            background:
                radial-gradient(circle at 50% 40%, rgba(46, 242, 255, 0.35), rgba(46, 242, 255, 0.08) 35%, transparent 60%),
                radial-gradient(circle at 35% 55%, rgba(255, 255, 255, 0.10), transparent 55%),
                radial-gradient(circle at 65% 60%, rgba(255, 255, 255, 0.08), transparent 55%);
            filter: blur(0px) saturate(110%);
            mix-blend-mode: screen;
            transition: opacity 200ms linear, transform 200ms linear, filter 200ms linear;
        }

        /* Clouds */
        #cloud-layer {
            position: fixed;
            inset: 0;
            z-index: 6;
            /* di atas background, di bawah scene */
            pointer-events: none;
            opacity: 0.55;
            filter: blur(0.2px);
        }

        .cloud {
            position: absolute;
            top: 10%;
            width: 320px;
            height: 120px;
            background-repeat: no-repeat;
            background-size: contain;
            opacity: 0.45;
            animation: cloud-drift linear infinite;
            will-change: transform;
        }

        @keyframes cloud-drift {
            from {
                transform: translateX(-40vw);
            }

            to {
                transform: translateX(140vw);
            }
        }

        /* Birds */
        #bird-layer {
            position: fixed;
            inset: 0;
            z-index: 7;
            pointer-events: none;
        }

        .bird {
            position: absolute;
            top: 18%;
            width: 48px;
            height: 24px;
            opacity: 0.35;
            animation: bird-fly linear infinite;
            will-change: transform;
            filter: drop-shadow(0 0 6px rgba(46, 242, 255, 0.15));
        }

        @keyframes bird-fly {
            from {
                transform: translateX(-20vw) translateY(0) scale(0.9);
            }

            50% {
                transform: translateX(50vw) translateY(-8px) scale(1);
            }

            to {
                transform: translateX(120vw) translateY(2px) scale(0.92);
            }
        }

        #status-display.disaster {
            font-family: var(--font-disaster);
            letter-spacing: 0.06em;
            text-transform: uppercase;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                cursor: auto !important;
            }

            #cursor-dot,
            #cursor-ring {
                display: none !important;
            }

            body.failure {
                animation: none !important;
            }

            #visual-canvas,
            #fx-canvas,
            #wave-canvas,
            #fish-canvas {
                display: none !important;
            }

            .radar-scan,
            .node.pulse,
            .cloud,
            .bird {
                animation: none !important;
            }

            #splash-overlay {
                display: none !important;
            }
        }

        /* HEADER */
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 1.5rem 2rem;
            z-index: var(--z-ui);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, rgba(5, 5, 7, 0.95), transparent);
            pointer-events: auto;
        }

        /* DRAMATIC LOGO */
        .floodzy-logo {
            font-family: 'Playfair Display SC', serif;
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            color: rgba(46, 242, 255, 0.3);
            position: relative;
            text-decoration: none;
            overflow: hidden;
            -webkit-box-reflect: below -8px linear-gradient(transparent, rgba(0, 0, 0, 0.3));
            background-image: linear-gradient(to top, #2EF2FF 50%, rgba(46, 242, 255, 0.3) 50%);
            background-size: 100% 200%;
            background-position: 0% 0%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: flood-fill 3s ease-out forwards;
        }

        @keyframes flood-fill {
            0% {
                background-position: 0% 0%;
            }

            100% {
                background-position: 0% 100%;
            }
        }

        .floodzy-logo::after {
            content: 'FLOODZY';
            position: absolute;
            top: 0;
            left: 0;
            color: transparent;
            text-shadow: 0 0 15px rgba(46, 242, 255, 0.5);
            opacity: 0;
            pointer-events: none;
            animation: glow-in 2s 1s forwards;
        }

        @keyframes glow-in {
            to {
                opacity: 1;
            }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* VISUAL CANVAS (RAIN) */
        #visual-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: var(--z-rain);
            pointer-events: none;
            opacity: 1;
            transition: opacity 2s;
        }

        /* UTILS */
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            position: relative;
            z-index: 2;
        }

        .mono {
            font-family: var(--font-mono);
            letter-spacing: -0.05em;
        }

        .text-cyan {
            color: var(--cyan);
            text-shadow: 0 0 10px var(--cyan-glow);
        }

        .text-red {
            color: var(--red);
            text-shadow: 0 0 10px var(--red-glow);
        }

        .text-warning {
            color: #FFD60A;
            text-shadow: 0 0 10px rgba(255, 214, 10, 0.35);
        }

        h1,
        h2,
        h3 {
            font-family: var(--font-display);
            line-height: 1.1;
            letter-spacing: -0.03em;
        }

        .nav-link {
            color: var(--text-muted);
            text-decoration: none;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            margin-left: 2rem;
            transition: color 0.3s;
            cursor: pointer;
        }

        .nav-link:hover {
            color: var(--cyan);
        }

        /* === SCENE 1: HERO (UPGRADED) === */
        .hero {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        #hero-title {
            transition: opacity 0.5s;
        }

        .hero-subtitle {
            transition: opacity 0.5s;
            opacity: 1;
        }

        /* HERO LENS EFFECT */
        .hero-lens {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 50% 30%, rgba(46, 242, 255, 0.35), rgba(46, 242, 255, 0.05) 40%, transparent 60%);
            opacity: 0;
            filter: blur(0px);
            transition: opacity 0.8s ease, filter 1s ease;
            z-index: 8;
            pointer-events: none;
        }

        .hero-submerge {
            position: absolute;
            inset: 0;
            backdrop-filter: blur(0px) saturate(100%);
            transition: backdrop-filter 1s ease;
            z-index: 7;
            pointer-events: none;
        }

        /* Triggered Classes */
        .hero.entering .hero-lens {
            opacity: 1;
            filter: blur(8px);
        }

        .hero.entering .hero-submerge {
            backdrop-filter: blur(12px) saturate(140%);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 1rem 2rem;
            background: rgba(46, 242, 255, 0.05);
            border: 1px solid var(--cyan);
            color: var(--cyan);
            font-family: var(--font-mono);
            font-size: 0.9rem;
            text-transform: uppercase;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            z-index: 10;
        }

        .btn:hover {
            background: var(--cyan);
            color: #000;
            box-shadow: 0 0 30px var(--cyan-glow);
        }

        /* === DIRECTOR'S CUT STAGE SCENES === */
        #director-stage {
            position: relative;
            height: 600vh;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        #sticky-viewport {
            position: sticky;
            top: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            background: radial-gradient(circle at 50% 10%, #1a1d2e 0%, #050507 80%);
        }

        /* City */
        .skyline {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%230a0c12' fill-opacity='1' d='M0,224L60,213.3C120,203,240,181,360,181.3C480,181,600,203,720,192C840,181,960,139,1080,128C1200,117,1320,139,1380,149.3L1440,160L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            background-size: cover;
            opacity: 0.5;
        }

        /* Props */
        .scenery-obj {
            position: absolute;
            bottom: 35%;
            transition: transform 2s ease;
            transform-origin: top center;
            z-index: 5;
        }

        .scenery-obj svg {
            fill: #232736;
            stroke: #555;
            height: 100%;
        }

        #obj-fence {
            left: 15%;
            width: 150px;
            height: 60px;
        }

        #obj-tree {
            right: 20%;
            width: 90px;
            height: 160px;
        }

        .fence-drift {
            transform: translateX(200px) rotate(15deg) translateY(100px);
            opacity: 0.5;
        }

        .tree-fall {
            transform: rotate(85deg) translateX(50px) translateY(50px);
            transform-origin: bottom center;
        }

        /* Sinking Letters */
        #sinking-text-container {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 1rem;
            z-index: var(--z-scene);
        }

        .sink-char {
            font-family: var(--font-display);
            font-size: 5rem;
            font-weight: 800;
            color: #FFF;
            transition: all 1s ease;
        }

        .drowning {
            transform: translateY(200px) rotate(20deg);
            opacity: 0;
            filter: blur(10px);
        }

        .resurfacing {
            animation: buoyant-rise 1.2s cubic-bezier(0.25, 1, 0.5, 1) forwards !important;
        }

        @keyframes buoyant-rise {
            0% {
                transform: translateY(150px) rotate(10deg);
                opacity: 0;
                filter: blur(5px);
            }

            50% {
                transform: translateY(-15px) rotate(-5deg);
                opacity: 1;
                filter: blur(0);
            }

            70% {
                transform: translateY(8px) rotate(3deg);
            }

            100% {
                transform: translateY(0) rotate(0);
            }
        }

        /* Rescue */
        #rescue-cord {
            position: absolute;
            top: -100px;
            left: 50%;
            width: 2px;
            height: 50vh;
            background: linear-gradient(to bottom, var(--cyan), transparent);
            transition: top 1s ease-out;
            z-index: var(--z-ui);
            cursor: help;
        }

        #rescue-drone {
            position: absolute;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            transition: top 1s ease-out, transform 2s ease-in-out;
            z-index: var(--z-ui);
        }

        .drone-light {
            animation: blink 0.5s infinite;
            fill: var(--red);
        }

        /* Water */
        .water-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            background: linear-gradient(to top, rgba(46, 242, 255, 0.5), rgba(46, 242, 255, 0.05));
            /* border-top: 3px solid rgba(46, 242, 255, 0.9); REMOVED */
            box-shadow: 0 -10px 40px rgba(46, 242, 255, 0.5);
            backdrop-filter: blur(4px);
            transition: height 0.1s linear;
            overflow: visible;
            /* Allow wave to stick out top */
            z-index: var(--z-water);
        }

        .water-noise {
            position: absolute;
            inset: 0;
            z-index: 24;
        }

        /* Fish layer: di bawah noise, di bawah wave */
        .fish-layer {
            /* DEPRECATED: Replaced by Canvas */
            display: none;
        }

        /* fish: subtle, underwater */
        #fish-canvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            z-index: 23;
            pointer-events: none;
            opacity: 0.35;
            mix-blend-mode: soft-light;
            filter: blur(0.3px);
        }

        /* PROCEDURAL CANVAS WAVE */
        #wave-canvas {
            position: absolute;
            top: -60px;
            /* Center wave on water surface */
            left: 0;
            width: 100%;
            height: 120px;
            pointer-events: none;
            z-index: 30;
        }

        .water-noise {
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.5'/%3E%3C/svg%3E");
            opacity: 0.4;
            mix-blend-mode: overlay;
            animation: water-drift 20s linear infinite;
        }

        @keyframes water-drift {
            from {
                background-position: 0 0;
            }

            to {
                background-position: 200px 0;
            }
        }

        #hud-overlay {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 60;
        }

        .system-grid-overlay {
            position: absolute;
            inset: 0;
            background-image: linear-gradient(rgba(46, 242, 255, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(46, 242, 255, 0.1) 1px, transparent 1px);
            background-size: 60px 60px;
            opacity: 0;
            transition: opacity 1s;
            z-index: 25;
            pointer-events: none;
        }

        /* === SPLIT === */
        #split-section {
            display: grid;
            grid-template-columns: 1fr 1px 1fr;
            border-top: 1px solid #222;
            min-height: 80vh;
            overflow: hidden;
        }

        .split-content {
            padding: 4rem;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .split-left {
            justify-content: flex-start;
            padding-top: 15vh;
            text-align: right;
            background: #08080a;
        }

        .split-right {
            justify-content: flex-end;
            padding-bottom: 20vh;
            text-align: left;
            background: var(--bg-void);
        }

        .split-divider {
            background: var(--cyan);
            height: 100%;
            box-shadow: 0 0 15px var(--cyan);
            opacity: 0.5;
        }

        /* === PLAYGROUND === */
        .playground-container {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 3rem;
            margin-top: 4rem;
            background: rgba(10, 12, 18, 0.6);
            border: 1px solid rgba(46, 242, 255, 0.1);
            padding: 3rem;
            position: relative;
            backdrop-filter: blur(10px);
        }

        .tech-corner {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid var(--cyan);
            opacity: 0.5;
            transition: opacity 0.3s;
        }

        .tech-corner.tl {
            top: -1px;
            left: -1px;
            border-right: none;
            border-bottom: none;
        }

        .tech-corner.tr {
            top: -1px;
            right: -1px;
            border-left: none;
            border-bottom: none;
        }

        .tech-corner.bl {
            bottom: -1px;
            left: -1px;
            border-right: none;
            border-top: none;
        }

        .tech-corner.br {
            bottom: -1px;
            right: -1px;
            border-left: none;
            border-top: none;
        }

        .playground-container:hover .tech-corner {
            opacity: 1;
            box-shadow: 0 0 10px var(--cyan-glow);
        }

        #sim-map {
            background: linear-gradient(rgba(46, 242, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(46, 242, 255, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            background-color: #08090f;
            height: 350px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(46, 242, 255, 0.1);
        }

        .radar-scan {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 150%;
            height: 150%;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(46, 242, 255, 0.1) 60deg, transparent 60.1deg);
            transform-origin: top left;
            animation: radar-spin 8s linear infinite;
            pointer-events: none;
        }

        .node {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(46, 242, 255, 0.2);
            border: 1px solid var(--cyan);
            transform: translate(-50%, -50%);
            transition: background 0.5s, border-color 0.5s, transform 0.3s;
        }

        .node::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 1px solid var(--cyan);
            opacity: 0;
            transform: translate(-50%, -50%) scale(1);
        }

        .node.pulse {
            animation: node-pulse 3s infinite;
        }

        .node.ripple::after {
            animation: node-ripple 1s ease-out;
        }

        .node.warning {
            background: rgba(255, 214, 10, 0.2);
            border-color: #FFD60A;
        }

        .node.critical {
            background: rgba(255, 59, 48, 0.5);
            border-color: var(--red);
            box-shadow: 0 0 15px var(--red);
            animation: critical-pulse 0.5s infinite alternate;
        }

        .map-hud {
            position: absolute;
            bottom: 10px;
            right: 10px;
            text-align: right;
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--cyan);
            opacity: 0.7;
            pointer-events: none;
        }

        @keyframes radar-spin {
            from {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        @keyframes node-pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                transform: translate(-50%, -50%) scale(1.2);
            }

            100% {
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @keyframes node-ripple {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(3);
            }
        }

        @keyframes critical-pulse {
            from {
                opacity: 0.5;
            }

            to {
                opacity: 1;
            }
        }

        .shaking {
            animation: shake 0.5s infinite;
        }

        @keyframes shake {
            0% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(5deg);
            }

            75% {
                transform: rotate(-5deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        /* === SUNRISE (FINAL) === */
        #final-sunrise {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: radial-gradient(circle at 50% 100%, rgba(46, 242, 255, 0.1) 0%, transparent 60%);
            position: relative;
            overflow: hidden;
            margin-bottom: 0;
            padding-bottom: 4rem;
        }

        .sun-orb {
            width: 400px;
            height: 400px;
            border-radius: 50%;
            background: radial-gradient(circle, #FFD60A, transparent 70%);
            position: absolute;
            bottom: -200px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: all 2.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            filter: blur(40px);
            z-index: 1;
        }

        .sun-orb.rise {
            bottom: -50px;
            opacity: 1;
        }

        /* FEATURE ADDITION: Final Node & Network */
        .final-node {
            position: relative;
            width: 14px;
            height: 14px;
            background: var(--cyan);
            border-radius: 50%;
            box-shadow: 0 0 30px var(--cyan);
            margin: 2rem auto;
            animation: pulse-node 2s infinite;
            z-index: 10;
        }

        @keyframes pulse-node {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.8);
                opacity: 0.6;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .final-network {
            position: absolute;
            inset: 0;
            background-image: radial-gradient(circle at 50% 50%, rgba(46, 242, 255, 0.15), transparent 60%);
            opacity: 0;
            transition: opacity 2s ease;
            z-index: 5;
        }

        /* === OPS FOOTER (ADDED) === */
        .ops-footer {
            border-top: 1px solid rgba(46, 242, 255, 0.2);
            background: #020202;
            padding: 4rem 0 2rem;
            position: relative;
            z-index: 50;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .footer-link {
            display: block;
            color: var(--text-muted);
            text-decoration: none;
            margin-bottom: 0.5rem;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            transition: color 0.3s;
        }

        .footer-link:hover {
            color: var(--cyan);
            letter-spacing: 1px;
        }

        .system-status-light {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--cyan);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--cyan);
            margin-right: 8px;
        }

        /* === MOBILE RESPONSIVENESS === */
        /* === MOBILE RESPONSIVENESS (OPTIMIZED) === */
        @media (max-width: 768px) {

            /* Typography Scale Down */
            html {
                font-size: 14px;
            }

            .floodzy-logo {
                font-size: 1.25rem;
            }

            h1 {
                font-size: 2.25rem !important;
                line-height: 1.1;
            }

            h2 {
                font-size: 1.75rem !important;
                line-height: 1.2;
            }

            p {
                font-size: 1rem !important;
            }

            /* Scrollytelling Elements */
            .sink-char {
                font-size: 3rem;
            }

            #hud-overlay {
                top: 100px;
                transform: translateX(-50%) scale(0.8);
            }

            /* Layout Stacking */
            #split-section {
                grid-template-columns: 1fr;
                min-height: auto;
            }

            .split-content {
                padding: 2.5rem 1.5rem;
                text-align: left;
            }

            .split-left {
                padding-top: 2rem;
                justify-content: flex-start;
            }

            .scenery-obj {
                transform-origin: bottom center;
            }

            #obj-fence {
                left: -20px;
                transform: scale(0.8);
            }

            #obj-tree {
                right: -30px;
                transform: scale(0.7);
            }

            #director-stage {
                height: 400vh;
            }

            .split-right {
                padding-bottom: 2rem;
                justify-content: flex-start;
                background: rgba(5, 5, 7, 0.5);
            }

            .split-divider {
                display: none;
            }

            /* Threat Playground */
            .playground-container {
                grid-template-columns: 1fr;
                gap: 1.5rem;
                padding: 1rem;
                margin-top: 1.5rem;
            }

            #sim-map {
                height: 200px;
            }

            /* Spacing Reductions */
            .container {
                padding: 0 1.25rem;
            }

            section.container {
                padding: 3rem 0 !important;
            }

            /* Section Tweaks */
            .mid-hero-title {
                font-size: 2rem !important;
                margin-bottom: 1rem;
            }

            .stats-grid {
                gap: 2rem;
            }

            .stats-grid>div {
                padding: 1.5rem !important;
            }

            /* Footer */
            .ops-footer {
                padding: 2rem 0;
            }

            /* Header Mobile */
            header {
                padding: 0.75rem 1rem;
            }

            .nav-link {
                margin-left: 0.75rem;
                font-size: 0.7rem;
            }
        }
    </style>
</head>

<body>
    <div id="redirect-overlay">
        <div style="font-size: 1.2rem; letter-spacing: 2px; margin-bottom: 1rem;">SYSTEM RESTORED</div>
        <div style="font-size: 0.9rem; color: #555;">CONNECTING TO DASHBOARD...</div>
        <div style="margin-top: 2rem; width: 200px; height: 2px; background: rgba(46,242,255,0.2);">
            <div style="width: 100%; height: 100%; background: var(--cyan); animation: load 1.5s ease-in-out infinite;">
            </div>
        </div>
        <style>
            @keyframes load {
                0% {
                    width: 0;
                    opacity: 0;
                }

                50% {
                    width: 100%;
                    opacity: 1;
                }

                100% {
                    opacity: 0;
                }
            }
        </style>
    </div>

    <!-- CURSOR -->
    <div id="cursor-dot"></div>
    <div id="cursor-ring"></div>

    <!-- RAIN -->
    <canvas id="visual-canvas"></canvas>

    <!-- ATMOSPHERE -->
    <div id="cloud-layer" aria-hidden="true"></div>
    <div id="bird-layer" aria-hidden="true"></div>

    <!-- FX: droplets + bubbles -->
    <canvas id="fx-canvas" aria-hidden="true"></canvas>

    <!-- Water splash overlay (ke kamera) -->
    <div id="splash-overlay" aria-hidden="true"></div>

    <!-- HEADER -->
    <header>
        <div class="logo">
            <!-- Replaced Text with Dramatic Logo -->
            <a href="/" class="floodzy-logo">FLOODZY</a>
        </div>
        <nav>
            <a href="/" class="nav-link">HOME</a>
            <a href="/peta-banjir" class="nav-link">DASHBOARD</a>
        </nav>
    </header>

    <!-- SCENE 1: HERO (UPDATED WITH LENS) -->
    <section class="hero">
        <div class="hero-lens" id="hero-lens"></div>
        <div class="hero-submerge" id="hero-submerge"></div>

        <div class="container" style="position: relative; z-index: 20;">
            <!-- Updated Copy -->
            <h1 id="hero-title" style="font-size: clamp(3rem, 8vw, 7rem);">Welcome to Floodzy World</h1>
            <p class="mono text-cyan" id="hero-status" style="margin-bottom: 2rem;">Simulation Initializing...</p>

            <div
                style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 2rem; position: relative; z-index: 50;">
                <a href="/peta-banjir" class="btn" onclick="localStorage.setItem('floodzy_seen', 'yes')">OPEN
                    DASHBOARD</a>
                <button
                    onclick="localStorage.setItem('floodzy_seen', 'yes'); document.getElementById('predict-section').scrollIntoView({behavior: 'smooth'})"
                    class="btn" style="border-style: dashed; padding: 1rem 1.5rem;">SKIP SIMULATION</button>
            </div>

            <div class="mono" style="opacity: 0.5;">↓ SCROLL TO BEGIN</div>
        </div>
    </section>

    <!-- TRUST STRIP -->
    <section class="container"
        style="padding: 2rem 0; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 2rem;">
        <p class="mono text-muted" style="font-size: 0.9rem; letter-spacing: 1px; text-transform: uppercase;">
            Realtime Telemetry • AI Forecasting • Kecamatan-Level Coverage • Alert-First UX
        </p>
    </section>

    <!-- WHAT IS FLOODZY -->
    <section class="container" style="padding: 4rem 0; text-align: center; max-width: 900px;">
        <h2 style="margin-bottom: 1.5rem;">The Flood Early Warning System</h2>
        <p class="text-muted" style="font-size: 1.25rem; margin-bottom: 3rem;">
            Floodzy is a realtime prediction platform built for BPBD, Government Agencies, and Citizens.
            We combine ground sensors, satellite data, and machine learning to visualize threats before they happen.
        </p>

        <!-- How It Works Cards -->
        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; text-align: left;">
            <div
                style="background: rgba(46, 242, 255, 0.05); border: 1px solid rgba(46, 242, 255, 0.2); padding: 2rem;">
                <div class="mono text-cyan" style="font-size: 1.5rem; margin-bottom: 1rem;">01. DETECT</div>
                <p class="text-muted">IoT sensors across key waterways transmit water level and rainfall data with
                    <strong>sub-second updates</strong>.
                </p>
            </div>
            <div
                style="background: rgba(46, 242, 255, 0.05); border: 1px solid rgba(46, 242, 255, 0.2); padding: 2rem;">
                <div class="mono text-cyan" style="font-size: 1.5rem; margin-bottom: 1rem;">02. PREDICT</div>
                <p class="text-muted">Our AI model processes topography and hydrology data to forecast flood spread.</p>
            </div>
            <div style="background: rgba(255, 59, 48, 0.05); border: 1px solid rgba(255, 59, 48, 0.3); padding: 2rem;">
                <div class="mono text-red" style="font-size: 1.5rem; margin-bottom: 1rem;">03. ALERT</div>
                <p class="text-muted">Instant warnings sent to stakeholders and citizens in affected zones.</p>
            </div>
        </div>
    </section>

    <!-- SCROLLYTELLING STAGE -->
    <div id="director-stage">
        <div id="sticky-viewport">
            <!-- HUD -->
            <div id="hud-overlay">
                <div class="mono text-cyan" id="zone-display" style="background: #000; padding: 5px 10px;">ZONE:
                    MONITORING</div>
                <h2 id="status-display" style="font-size: 2.5rem; margin-top: 10px;">NORMAL</h2>
            </div>

            <!-- CITY -->
            <div class="skyline"></div>

            <!-- PROPS -->
            <div class="scenery-obj" id="obj-fence">
                <svg viewBox="0 0 150 60">
                    <path
                        d="M10,60 L10,10 M30,60 L30,10 M50,60 L50,10 M70,60 L70,10 M90,60 L90,10 M110,60 L110,10 M130,60 L130,10 M0,20 L150,20 M0,50 L150,50"
                        stroke="#555" stroke-width="2" />
                </svg>
            </div>
            <div class="scenery-obj" id="obj-tree">
                <svg viewBox="0 0 80 180">
                    <path d="M40,180 L40,100 M40,100 L10,60 M40,100 L70,60 M40,80 L20,40 M40,80 L60,40" stroke="#555"
                        stroke-width="4" />
                    <circle cx="40" cy="40" r="30" fill="#232736" stroke="#555" />
                </svg>
            </div>

            <!-- SINKING TEXT -->
            <div id="sinking-text-container">
                <span class="sink-char">F</span>
                <span class="sink-char">L</span>
                <span class="sink-char">O</span>
                <span class="sink-char">O</span>
                <span class="sink-char">D</span>
                <span class="sink-char">Z</span>
                <span class="sink-char">Y</span>
            </div>

            <!-- RESCUE SYSTEM -->
            <div id="rescue-cord" title="Evacuation Window Open"></div>
            <div id="rescue-drone">
                <svg width="60" height="40" viewBox="0 0 60 40">
                    <path d="M10,20 L50,20 M0,10 L20,20 L0,30 M60,10 L40,20 L60,30" stroke="#333" fill="none" />
                    <circle cx="30" cy="20" r="5" fill="#111" stroke="var(--cyan)" />
                    <circle cx="30" cy="20" r="2" class="drone-light" />
                </svg>
            </div>

            <!-- WATER & GRID -->
            <div class="water-overlay" id="water-level">
                <canvas id="wave-canvas"></canvas>

                <!-- FISH -->
                <canvas id="fish-canvas" aria-hidden="true"></canvas>

                <div class="water-noise"></div>
            </div>
            <div class="system-grid-overlay" id="intervention-grid"></div>
        </div>
    </div>

    <!-- SCENE 8: SPLIT NARRATIVE -->
    <section id="split-section">
        <div class="split-content split-left">
            <h3 class="text-red">MANUAL CHAOS</h3>
            <p class="text-muted" style="font-size: 1.5rem; max-width: 400px; margin-left: auto;">
                "Fragmented data reporting delays critical response. Manual observation creates blind spots when minutes
                matter."
            </p>
        </div>
        <div class="split-divider"></div>
        <div class="split-content split-right">
            <h3 class="text-cyan">SYSTEM CLARITY</h3>
            <p style="font-size: 1.5rem; max-width: 400px;">
                "Real-time sensor fusion eliminates latency. Floodzy predicts impact magnitude before the storm peaks."
            </p>
        </div>
    </section>

    <!-- SCENE: MID HERO (PREDICT SURGE) -->
    <!-- SCENE: MID HERO (PREDICT SURGE) -->
    <section id="predict-section" class="container"
        style="padding: 4rem 0 6rem 0; position: relative; z-index: 20; text-align: center;">
        <div class="mono text-cyan" style="margin-bottom: 1.5rem; letter-spacing: 2px;">:: SYSTEM STATUS: ONLINE</div>

        <h2 style="font-size: clamp(3.5rem, 6vw, 5.5rem); line-height: 1.1; margin-bottom: 2rem;">
            Predict the Surge.<br>
            <span style="color: #666;">Before it Strikes.</span>
        </h2>

        <p class="text-muted" style="font-size: 1.25rem; max-width: 700px; margin: 0 auto 3rem; line-height: 1.6;">
            Advanced flood intelligence for a changing climate. Combining satellite altimetry, ML forecasting, and
            real-time ground telemetry.
        </p>

        <a href="#" class="btn"
            style="padding: 1rem 2.5rem; border-color: var(--cyan); background: rgba(46,242,255,0.1);">
            LAUNCH CONSOLE <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" style="margin-left:8px;">
                <path d="M7 17l9.2-9.2M17 17V7H7" />
            </svg>
        </a>
    </section>

    <!-- SCENE 9: PLAYGROUND -->
    <section class="container" style="padding: 6rem 0;">
        <div class="mono text-cyan">> THREAT_PLAYGROUND</div>
        <h2>Control the Chaos</h2>

        <div class="playground-container">
            <div class="tech-corner tl"></div>
            <div class="tech-corner tr"></div>
            <div class="tech-corner bl"></div>
            <div class="tech-corner br"></div>

            <div id="sim-map">
                <div class="radar-scan"></div>
                <div class="map-hud">
                    LAT: -6.2088<br>LON: 106.8456<br>SENSORS: <span id="sensor-count">12</span> LIVE<br>SYNC: ACTIVE
                </div>
            </div>

            <div>
                <div style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between;"><span class="mono">RAIN
                            INTENSITY</span><span class="mono text-cyan" id="rain-val">20%</span></div>
                    <input type="range" id="rain-slider" min="0" max="100" value="20"
                        style="width: 100%; margin-top: 10px;">
                </div>
                <div>
                    <div style="display: flex; justify-content: space-between;"><span class="mono">RIVER
                            LEVEL</span><span class="mono text-red" id="river-val">SAFE</span></div>
                    <input type="range" id="river-slider" min="0" max="100" value="10"
                        style="width: 100%; margin-top: 10px;">
                </div>
                <p class="mono text-muted" style="font-size: 0.8rem; margin-top: 2rem;">ADJUST SLIDERS TO SIMULATE
                    SENSOR FEEDBACK.</p>
            </div>
        </div>
    </section>

    <!-- SCENE 10: DEPLOYMENT STATS (RESTORED) -->
    <section class="container" style="padding: 6rem 0; position: relative; z-index: 20;">
        <div class="stats-grid">
            <!-- Left: Narrative -->
            <div>
                <div class="mono text-cyan" style="margin-bottom: 1rem;">01 :: THE PROBLEM</div>
                <h2 style="font-size: clamp(2.5rem, 5vw, 3.5rem); margin-bottom: 3rem; line-height: 1.1;">Water Doesn't
                    Wait.<br>Neither Should You.</h2>

                <div
                    style="background: rgba(255,255,255,0.03); border-left: 2px solid #555; padding: 2rem; margin-bottom: 2rem;">
                    <h4 style="margin-bottom: 0.5rem; color: #FFF;">Latency Kills Response</h4>
                    <p class="text-muted">Traditional manual gauges have a 4-hour delay loop. Floodzy cuts this to
                        <strong>sub-second updates</strong>
                        utilizing direct IoT uplinks.
                    </p>
                </div>

                <div style="background: rgba(255,255,255,0.03); border-left: 2px solid #555; padding: 2rem;">
                    <h4 style="margin-bottom: 0.5rem; color: #FFF;">Invisible Threats</h4>
                    <p class="text-muted">Rain forecasts are not flood forecasts. We model terrain hydrology to predict
                        impact, not just precipitation.</p>
                </div>
            </div>

            <!-- Right: Stats Panel -->
            <div
                style="background: #0B0D13; border: 1px solid rgba(46,242,255,0.2); padding: 3rem; border-radius: 4px; position: relative;">
                <div class="mono text-cyan" style="margin-bottom: 2rem;">> DEPLOYMENT_STATS</div>

                <div
                    style="font-size: clamp(4rem, 8vw, 6rem); font-weight: 800; line-height: 1; color: #FFF; font-family: var(--font-display);">
                    3h</div>
                <div class="text-muted" style="margin-bottom: 4rem;">Early Warning Lead Time</div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div
                        style="background: rgba(46, 242, 255, 0.05); border-bottom: 2px solid var(--cyan); padding: 1.5rem; height: 100px; display: flex; align-items: end;">
                        <span class="mono text-cyan" style="font-size: 0.8rem;">RIVER_GAUGE</span>
                    </div>
                    <div
                        style="background: rgba(255, 59, 48, 0.05); border-bottom: 2px solid var(--red); padding: 1.5rem; height: 100px; display: flex; align-items: end;">
                        <span class="mono text-red" style="font-size: 0.8rem;">ALERT_RISK</span>
                    </div>
                </div>
            </div>
        </div>
        <style>
            .stats-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 4rem;
                align-items: start;
            }

            @media (max-width: 768px) {
                .stats-grid {
                    grid-template-columns: 1fr;
                    gap: 2rem;
                }
            }
        </style>
    </section>

    <!-- SCENE 11: SUNRISE (UPDATED WITH QUIET MOMENT) -->
    <section id="final-sunrise">
        <div class="sun-orb"></div>
        <div class="final-network"></div>
        <div class="final-node"></div>

        <div class="container" style="position: relative; z-index: 20;">
            <p class="mono" style="font-size: 1.2rem; margin-bottom: 0.5rem;">YOU CAN'T STOP THE RAIN.</p>
            <p class="mono text-red" style="font-size: 1.2rem; margin-bottom: 2rem;">BUT YOU CAN SEE IT COMING.</p>
            <p class="mono text-cyan" style="margin-top:1rem; font-size: 1.5rem; max-width: 600px; margin: 0 auto;">
                FLOODZY IS THE DIFFERENCE BETWEEN WARNING AND LOSS.
            </p>
            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 3rem;">
                <a href="/peta-banjir" class="btn" onclick="localStorage.setItem('floodzy_seen', 'yes')">OPEN
                    DASHBOARD</a>
                <a href="/contact" class="btn" style="border-color: rgba(255,255,255,0.3); color: #fff;">REQUEST
                    DEMO</a>
            </div>
        </div>
    </section>

    <footer class="ops-footer">
        <div class="container">
            <div class="footer-grid">
                <div>
                    <div class="logo mono text-cyan" style="margin-bottom: 1rem;">FLOODZY_INTEL</div>
                    <p class="text-muted" style="font-size: 0.9rem; max-width: 300px;">
                        Advanced hydrological predictive system for urban resilience.
                    </p>
                    <div style="margin-top: 1rem; display: flex; align-items: center;">
                        <span class="system-status-light"></span>
                        <span class="mono" style="font-size: 0.8rem; color: var(--cyan);">SYSTEM OPERATIONAL</span>
                    </div>
                </div>

                <div>
                    <h4 class="mono text-main" style="margin-bottom: 1rem;">// NAVIGATION</h4>
                    <a href="/" class="footer-link">HOME_BASE</a>
                    <a href="/peta-banjir" class="footer-link">LIVE_DASHBOARD</a>
                    <a href="/prakiraan-cuaca" class="footer-link">WEATHER_INTEL</a>
                    <a href="#" onclick="localStorage.removeItem('floodzy_seen'); location.reload();"
                        class="footer-link" style="color: #666; margin-top: 1rem;">↺ REPLAY_INTRO</a>
                </div>

                <div>
                    <h4 class="mono text-main" style="margin-bottom: 1rem;">// CONNECT</h4>
                    <a href="#" class="footer-link">GITHUB_REPO</a>
                    <a href="#" class="footer-link">CONTACT_HQ</a>
                    <p class="mono text-muted" style="margin-top: 1rem; font-size: 0.8rem;">
                        JAKARTA • INDONESIA
                        <br>LAT: -6.2088 | LON: 106.8456
                    </p>
                </div>
            </div>

            <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem; text-align: center;">
                <p class="mono text-muted" style="font-size: 0.75rem;">
                    © 2026 FLOODZY SYSTEMS. ALL RIGHTS RESERVED. | <span
                        class="text-cyan">SECURE_CONNECTION_ESTABLISHED</span>
                </p>
            </div>
        </div>
    </footer>

    <script>
        // === GLOBAL VARIABLES & SETUP ===
        const rainCanvas = document.getElementById('visual-canvas');
        const rainCtx = rainCanvas.getContext('2d');
        const waveCanvas = document.getElementById('wave-canvas');
        const waveCtx = waveCanvas.getContext('2d');
        const fxCanvas = document.getElementById('fx-canvas');
        const fxCtx = fxCanvas.getContext('2d');

        const cloudLayer = document.getElementById('cloud-layer');
        const birdLayer = document.getElementById('bird-layer');
        const splashOverlay = document.getElementById('splash-overlay');

        // Scroll Logic Elements
        const hero = document.querySelector('.hero');
        const heroTitle = document.getElementById('hero-title');
        const heroStatus = document.getElementById('hero-status');
        const stage = document.getElementById('director-stage');
        const water = document.getElementById('water-level');
        const chars = document.querySelectorAll('.sink-char');
        const cord = document.getElementById('rescue-cord');
        const drone = document.getElementById('rescue-drone');
        const grid = document.getElementById('intervention-grid');
        const status = document.getElementById('status-display');
        const hud = document.getElementById('zone-display');
        const fence = document.getElementById('obj-fence');
        const tree = document.getElementById('obj-tree');

        // State Variables
        let width, height;
        let globalRain = 20;
        let isPageVisible = true;
        let scrollSpeed = 0;
        let lastY = window.scrollY;
        let lastT = performance.now();
        let heroTriggered = false;

        // RAF IDs (Safety Pattern)
        let rainRaf = 0;
        let waveRaf = 0;
        let fxRaf = 0;
        let cursorRaf = 0;

        // Fish Globals
        const fishCanvas = document.getElementById('fish-canvas');
        const fishCtx = fishCanvas.getContext('2d');
        let fishRaf = 0;
        let fishW = 0, fishH = 0;

        // Data Arrays
        const rains = [];
        const droplets = [];
        const bubbles = [];
        const fishes = [];
        const FISH_MAX = 10;

        // Reduced Motion
        const reduceMotionMQ = window.matchMedia('(prefers-reduced-motion: reduce)');
        function shouldAnimate() { return !reduceMotionMQ.matches; }

        // === CLASS DEFINITIONS ===
        class Drop {
            constructor() { this.init(); }
            init() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.speed = Math.random() * 8 + 5;
                this.len = Math.random() * 30 + 10;
                this.alpha = Math.random() * 0.2 + 0.05;
            }
            update(intensity) {
                this.y += this.speed + (intensity / 5);
                if (this.y > height) { this.y = -20; this.x = Math.random() * width; }
            }
            draw() {
                rainCtx.strokeStyle = `rgba(46, 242, 255, ${this.alpha})`;
                rainCtx.lineWidth = 1;
                rainCtx.beginPath(); rainCtx.moveTo(this.x, this.y); rainCtx.lineTo(this.x, this.y + this.len); rainCtx.stroke();
            }
        }

        // === RESIZE HANDLER ===
        function setupCanvas(canvas, ctx, cssW, cssH) {
            const dpr = Math.min(2, window.devicePixelRatio || 1);
            canvas.width = Math.floor(cssW * dpr);
            canvas.height = Math.floor(cssH * dpr);
            canvas.style.width = cssW + 'px';
            canvas.style.height = cssH + 'px';
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            return dpr;
        }

        function syncFishCanvas(force = false) {
            if (!fishCanvas || !fishCtx || !water) return;

            const r = water.getBoundingClientRect();
            const cssW = Math.max(0, Math.floor(r.width));
            const cssH = Math.max(0, Math.floor(r.height));

            if (!force && Math.abs(cssW - fishW) < 2 && Math.abs(cssH - fishH) < 2) return;

            fishW = cssW;
            fishH = cssH;

            // Keep CSS sizing controlled by stylesheet (100%)
            fishCanvas.style.width = '100%';
            fishCanvas.style.height = '100%';

            const dpr = Math.min(2, window.devicePixelRatio || 1);
            fishCanvas.width = Math.floor(cssW * dpr);
            fishCanvas.height = Math.floor(cssH * dpr);
            fishCtx.setTransform(dpr, 0, 0, dpr, 0, 0);

            // Optional: kalau air tipis, bersihin & kosongkan ikan biar gak “nyangkut”
            if (fishH < 40) {
                fishes.length = 0;
                fishCtx.clearRect(0, 0, fishW, fishH);
            }
        }

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;

            setupCanvas(rainCanvas, rainCtx, width, height);
            setupCanvas(fxCanvas, fxCtx, width, height);



            if (waveCanvas) {
                setupCanvas(waveCanvas, waveCtx, width, 120);
            }
            syncFishCanvas(true);

            // Mobile Opt: Resize Rain Array
            const targetCount = width < 768 ? 40 : 100;
            if (rains.length > targetCount) rains.length = targetCount;
            // Only push if width is defined and we need more
            if (width) {
                while (rains.length < targetCount) rains.push(new Drop());
            }
        }
        window.addEventListener('resize', resize);

        // Performance: Pause FX when stage not visible
        const stageObserver = new IntersectionObserver((entries) => {
            entries.forEach(e => {
                if (!e.isIntersecting) { stopWave(); stopFx(); stopFish(); }
                else { startWave(); startFx(); startFish(); }
            });
        }, { threshold: 0 });
        if (stage) stageObserver.observe(stage);

        // === INITIALIZATION ===
        resize(); // Set initial W/H
        // Initial populate (safe now that dimensions are set)
        while (rains.length < (width < 768 ? 40 : 100)) rains.push(new Drop());

        // === ATMOSPHERE INIT ===
        function svgCloudDataUri() {
            const svg = `
          <svg xmlns='http://www.w3.org/2000/svg' width='420' height='160' viewBox='0 0 420 160'>
            <defs>
              <linearGradient id='g' x1='0' y1='0' x2='0' y2='1'>
                <stop offset='0' stop-color='rgba(46,242,255,0.20)'/>
                <stop offset='1' stop-color='rgba(46,242,255,0.02)'/>
              </linearGradient>
            </defs>
            <path d='M110 120c-35 0-60-20-60-45 0-22 18-40 44-44 10-20 32-33 58-33 30 0 55 18 62 43 26 2 46 20 46 42 0 25-25 37-56 37H110z' fill='url(#g)'/>
          </svg>`;
            return `url("data:image/svg+xml,${encodeURIComponent(svg)}")`;
        }
        function svgBirdDataUri() {
            const svg = `
          <svg xmlns='http://www.w3.org/2000/svg' width='80' height='40' viewBox='0 0 80 40'>
            <path d='M5 25c10-10 20-10 30 0 10-10 20-10 30 0' fill='none' stroke='rgba(46,242,255,0.45)' stroke-width='3' stroke-linecap='round'/>
          </svg>`;
            return `url("data:image/svg+xml,${encodeURIComponent(svg)}")`;
        }
        function initAtmos() {
            const cloudBg = svgCloudDataUri();
            for (let i = 0; i < 5; i++) {
                const c = document.createElement('div');
                c.className = 'cloud';
                c.style.backgroundImage = cloudBg;
                c.style.top = (8 + Math.random() * 22) + '%';
                c.style.left = (-40 - Math.random() * 60) + 'vw';
                c.style.opacity = (0.25 + Math.random() * 0.25).toFixed(2);
                c.style.transform = `scale(${(0.6 + Math.random() * 0.7).toFixed(2)})`;
                c.style.animationDuration = (45 + Math.random() * 45).toFixed(0) + 's';
                c.style.animationDelay = (-Math.random() * 40).toFixed(0) + 's';
                cloudLayer.appendChild(c);
            }
            const birdBg = svgBirdDataUri();
            for (let i = 0; i < 4; i++) {
                const b = document.createElement('div');
                b.className = 'bird';
                b.style.backgroundImage = birdBg;
                b.style.top = (12 + Math.random() * 18) + '%';
                b.style.left = (-20 - Math.random() * 30) + 'vw';
                b.style.opacity = (0.18 + Math.random() * 0.25).toFixed(2);
                b.style.animationDuration = (18 + Math.random() * 20).toFixed(0) + 's';
                b.style.animationDelay = (-Math.random() * 16).toFixed(0) + 's';
                birdLayer.appendChild(b);
            }
        }
        initAtmos();

        // === ANIMATION LOOP FUNCTIONS ===

        // 1. Rain
        function animateRain() {
            rainCtx.clearRect(0, 0, width, height);
            rains.forEach(r => { r.update(globalRain); r.draw(); });
            rainRaf = requestAnimationFrame(animateRain);
        }
        function startRain() { if (!rainRaf) rainRaf = requestAnimationFrame(animateRain); }
        function stopRain() { if (!rainRaf) return; cancelAnimationFrame(rainRaf); rainRaf = 0; }

        // 2. Wave
        let waveTime = 0;
        const WAVE_H = 120;
        function drawWave(level = 20) {
            if (!waveCtx) return;
            // Use CSS units for clearRect and logic
            waveCtx.clearRect(0, 0, width, WAVE_H);
            const baseHeight = WAVE_H * 0.5;
            const amp = 10 + (level * 0.3);
            waveCtx.beginPath();
            waveCtx.moveTo(0, baseHeight);
            // Draw using CSS pixels (width) not buffer width
            for (let x = 0; x <= width; x += 2) {
                const y = Math.sin(x * 0.01 + waveTime) * amp +
                    Math.sin(x * 0.02 + waveTime * 1.5) * (amp * 0.5) +
                    Math.sin(x * 0.005 + waveTime * 0.5) * (amp * 0.2);
                waveCtx.lineTo(x, baseHeight + y);
            }
            waveCtx.lineTo(width, WAVE_H);
            waveCtx.lineTo(0, WAVE_H);
            waveCtx.closePath();
            const grad = waveCtx.createLinearGradient(0, 0, 0, WAVE_H);
            grad.addColorStop(0, 'rgba(46, 242, 255, 0.9)');
            grad.addColorStop(1, 'rgba(46, 242, 255, 0.1)');
            waveCtx.fillStyle = grad;
            waveCtx.shadowColor = 'rgba(46, 242, 255, 0.8)';
            waveCtx.shadowBlur = 15;
            waveCtx.fill();
            waveCtx.globalCompositeOperation = 'source-atop';
            waveCtx.fillStyle = 'rgba(255,255,255,0.3)';
            if (level > 60) waveCtx.fillRect(0, 0, width, 15);
            waveCtx.globalCompositeOperation = 'source-over';
            waveCtx.shadowBlur = 0;
        }
        function loopWave() {
            waveTime += 0.02;
            drawWave(globalRain);
            waveRaf = requestAnimationFrame(loopWave);
        }
        function startWave() { if (!waveRaf) waveRaf = requestAnimationFrame(loopWave); }
        function stopWave() { if (!waveRaf) return; cancelAnimationFrame(waveRaf); waveRaf = 0; }

        // 3. FX (Droplets + Bubbles)
        const MAX_DROPLETS = 600;
        const MAX_BUBBLES = 300;

        function spawnDropletBurst(power) {
            if (droplets.length > MAX_DROPLETS) return;
            const count = Math.floor(18 + power * 42);
            for (let i = 0; i < count; i++) {
                droplets.push({
                    x: window.innerWidth * (0.25 + Math.random() * 0.5),
                    y: window.innerHeight * (0.35 + Math.random() * 0.35),
                    vx: (Math.random() - 0.5) * (3 + power * 10),
                    vy: (-2 - Math.random() * 6) * (1 + power),
                    r: 1 + Math.random() * (2 + power * 3),
                    a: 0.25 + Math.random() * 0.35,
                    life: 1
                });
            }
        }
        function spawnBubbleBurst(x, count = 5) {
            if (bubbles.length >= MAX_BUBBLES) return;
            const remaining = MAX_BUBBLES - bubbles.length;
            const c = Math.min(count, remaining);

            for (let i = 0; i < c; i++) {
                bubbles.push({
                    x: x + (Math.random() - 0.5) * 20,
                    y: window.innerHeight + 10,
                    vy: 2 + Math.random() * 3, // Faster upward speed
                    r: 2 + Math.random() * 5,
                    a: 0.4 + Math.random() * 0.4,
                    wobble: Math.random() * Math.PI * 2
                });
            }
        }
        function spawnBubble() {
            if (bubbles.length > MAX_BUBBLES) return;
            if (!water) return;
            const waterRect = water.getBoundingClientRect();
            if (waterRect.height < 40) return;
            const x = Math.random() * window.innerWidth;
            const y = waterRect.top + waterRect.height - (Math.random() * 20);
            bubbles.push({
                x, y,
                vy: 0.4 + Math.random() * 1.2,
                r: 1.5 + Math.random() * 4,
                a: 0.10 + Math.random() * 0.18,
                wobble: Math.random() * Math.PI * 2
            });
        }
        function fxLoop() {
            fxCtx.clearRect(0, 0, width, height);

            // Spawn logic
            const bubbleRate = (globalRain / 100) * 0.8;
            if (Math.random() < bubbleRate) spawnBubble();

            // Render Bubbles
            fxCtx.globalCompositeOperation = 'lighter';
            for (let i = bubbles.length - 1; i >= 0; i--) {
                const b = bubbles[i];
                b.wobble += 0.06;
                b.y -= b.vy;
                b.x += Math.sin(b.wobble) * 0.35;
                b.a *= 0.998;
                fxCtx.beginPath(); fxCtx.strokeStyle = `rgba(255,255,255,${b.a})`;
                fxCtx.lineWidth = 1; fxCtx.arc(b.x, b.y, b.r, 0, Math.PI * 2); fxCtx.stroke();
                if (b.y < 0 || b.a < 0.02) bubbles.splice(i, 1);
            }

            // Render Droplets
            fxCtx.globalCompositeOperation = 'screen';
            for (let i = droplets.length - 1; i >= 0; i--) {
                const d = droplets[i];
                d.x += d.vx; d.y += d.vy; d.vy += 0.18; d.vx *= 0.985;
                d.life *= 0.965; d.a *= 0.97;
                fxCtx.beginPath(); fxCtx.fillStyle = `rgba(46,242,255,${d.a})`;
                fxCtx.arc(d.x, d.y, d.r, 0, Math.PI * 2); fxCtx.fill();
                if (d.life < 0.08 || d.y > window.innerHeight + 50) droplets.splice(i, 1);
            }
            fxCtx.globalCompositeOperation = 'source-over';
            fxRaf = requestAnimationFrame(fxLoop);
        }
        function startFx() { if (!fxRaf) fxRaf = requestAnimationFrame(fxLoop); }
        function stopFx() { if (!fxRaf) return; cancelAnimationFrame(fxRaf); fxRaf = 0; }





        function rand(a, b) { return a + Math.random() * (b - a); }

        function spawnFish() {
            if (fishes.length >= FISH_MAX) return;
            const dir = Math.random() > 0.5 ? 1 : -1;
            const depth = rand(0.2, 1.0);        // 0 dekat kamera, 1 jauh
            const s = 0.6 + (1.1 - depth) * 0.8; // makin dekat = makin besar
            fishes.push({
                x: dir === 1 ? -rand(30, 120) : fishW + rand(30, 120),
                y: rand(fishH * 0.55, fishH * 0.95), // selalu bawah (lebih natural)
                dir,
                depth,
                s,
                sp: (0.35 + (1.2 - depth) * 0.9) * (dir),
                ph: rand(0, Math.PI * 2),
                wob: rand(0.6, 1.4),
                life: rand(0.6, 1.0),
            });
        }

        function drawFishShape(ctx, x, y, s, dir, t, depth) {
            // Silhouette + rim light tipis
            const bodyL = 26 * s;
            const bodyH = 10 * s;
            const tailL = 10 * s;

            const bob = Math.sin(t * 1.2 + depth * 4) * (1.2 * s);
            const sway = Math.sin(t * 2.4 + depth * 3) * (0.35 * s);

            ctx.save();
            ctx.translate(x, y + bob);
            ctx.scale(dir, 1);

            // body
            ctx.beginPath();
            ctx.ellipse(0, 0, bodyL * 0.5, bodyH * 0.5, sway, 0, Math.PI * 2);

            // tail
            ctx.moveTo(-bodyL * 0.55, 0);
            ctx.lineTo(-bodyL * 0.55 - tailL, -bodyH * 0.35);
            ctx.lineTo(-bodyL * 0.55 - tailL, bodyH * 0.35);
            ctx.closePath();

            // fill silhouette (gelap halus supaya “underwater”)
            ctx.fillStyle = `rgba(0,0,0,${0.10 + (1 - depth) * 0.08})`;
            ctx.fill();

            // rim light
            ctx.strokeStyle = `rgba(46,242,255,${0.08 + (1 - depth) * 0.10})`;
            ctx.lineWidth = 1;
            ctx.stroke();

            ctx.restore();
        }

        function fishLoop() {
            if (!fishCtx) { fishRaf = 0; return; }

            // Jangan matikan loop; cukup skip render kalau air tipis
            if (fishH < 40 || fishW < 40) {
                fishRaf = requestAnimationFrame(fishLoop);
                return;
            }

            fishCtx.clearRect(0, 0, fishW, fishH);

            // ikan cuma muncul kalau air sudah cukup tinggi
            // (kalau mau selalu ada, hapus kondisi ini)
            const waterRect = water.getBoundingClientRect();
            if (waterRect.height < window.innerHeight * 0.35) {
                fishRaf = requestAnimationFrame(fishLoop);
                return;
            }

            // spawn rate menyesuaikan intensitas
            const spawnChance = 0.015 + (globalRain / 100) * 0.02;
            if (Math.random() < spawnChance) spawnFish();

            const t = performance.now() / 1000;

            for (let i = fishes.length - 1; i >= 0; i--) {
                const f = fishes[i];
                f.x += f.sp;
                f.ph += 0.02 * f.wob;

                // kecilkan “kehadiran” saat CRITICAL biar tidak ramai
                const fade = (globalRain > 85) ? 0.6 : 1.0;

                fishCtx.globalAlpha = f.life * fade;
                drawFishShape(fishCtx, f.x, f.y, f.s, f.dir, t + f.ph, f.depth);

                // wrap / kill
                if (f.dir === 1 && f.x > fishW + 140) fishes.splice(i, 1);
                else if (f.dir === -1 && f.x < -140) fishes.splice(i, 1);
            }
            fishCtx.globalAlpha = 1;

            fishRaf = requestAnimationFrame(fishLoop);
        }

        function startFish() { if (!fishRaf) fishRaf = requestAnimationFrame(fishLoop); }
        function stopFish() { if (!fishRaf) return; cancelAnimationFrame(fishRaf); fishRaf = 0; }

        // === START ANIMATIONS ===
        if (shouldAnimate()) {
            startRain();
            startWave();
            startFx();
            startFish();
        }

        // === CURSOR LOGIC ===
        const dot = document.getElementById('cursor-dot');
        const ring = document.getElementById('cursor-ring');
        let cursorX = 0, cursorY = 0, ringX = 0, ringY = 0, isCursorActive = false;

        function cursorLoop() {
            if (!isCursorActive) { cursorRaf = 0; return; }
            ringX += (cursorX - ringX) * 0.15; ringY += (cursorY - ringY) * 0.15;
            ring.style.transform = `translate3d(${ringX}px, ${ringY}px, 0) translate(-50%, -50%)`;
            cursorRaf = requestAnimationFrame(cursorLoop);
        }
        function startCursor() { if (!cursorRaf && isCursorActive) cursorRaf = requestAnimationFrame(cursorLoop); }
        function stopCursor() { if (!cursorRaf) return; cancelAnimationFrame(cursorRaf); cursorRaf = 0; }

        document.addEventListener('mousemove', e => {
            if (window.matchMedia('(pointer: coarse)').matches) return;
            cursorX = e.clientX; cursorY = e.clientY;
            dot.style.display = 'block';
            dot.style.transform = `translate3d(${cursorX}px, ${cursorY}px, 0) translate(-50%, -50%)`;
            if (!isCursorActive) {
                isCursorActive = true;
                ring.style.display = 'block';
                ringX = cursorX;
                ringY = cursorY;
                startCursor();
            }
        });

        // === SCROLL & INTERACTION Logic ===
        function updateScrollSpeed() {
            const now = performance.now();
            const dy = Math.abs(window.scrollY - lastY);
            const dt = Math.max(16, now - lastT);
            scrollSpeed = Math.min(1, (dy / dt) * 0.9);
            lastY = window.scrollY;
            lastT = now;
        }
        window.addEventListener('scroll', updateScrollSpeed, { passive: true });

        // Hero Transition
        window.addEventListener('scroll', () => {
            if (window.scrollY > 40 && !heroTriggered) {
                hero.classList.add('entering');
                heroTriggered = true;
                setTimeout(() => {
                    heroTitle.style.opacity = 0; heroStatus.style.opacity = 0;
                    setTimeout(() => {
                        heroTitle.innerText = "Predict the Surge.";
                        heroStatus.innerText = "Director's Cut Simulation";
                        heroTitle.style.opacity = 1; heroStatus.style.opacity = 1;
                    }, 500);
                }, 800);
            }
        });

        // Loop for Scroll Speed + handleScroll
        let ticking = false;
        window.addEventListener('scroll', () => {
            if (!ticking) {
                requestAnimationFrame(() => { handleScroll(); ticking = false; });
                ticking = true;
            }
        });

        function easeInOut(t) { return t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2; }

        function applySplashFX(p) {
            const inCriticalBand = (p > 0.40 && p < 0.72);
            const power = inCriticalBand ? Math.min(1, (p - 0.40) / 0.18) : 0;
            const overlayOpacity = Math.min(0.85, power * (0.35 + scrollSpeed * 0.9));
            splashOverlay.style.opacity = overlayOpacity.toFixed(3);
            splashOverlay.style.transform = `scale(${(0.98 + power * 0.05).toFixed(3)})`;
            splashOverlay.style.filter = `blur(${(power * 6).toFixed(1)}px) saturate(${(110 + power * 25).toFixed(0)}%)`;
            if (inCriticalBand && scrollSpeed > 0.35 && Math.random() > 0.35) {
                spawnDropletBurst(Math.min(1, power + scrollSpeed));
            }
        }

        function handleScroll() {
            const rect = stage.getBoundingClientRect();
            let rawP = (window.innerHeight - rect.top) / rect.height;
            rawP = Math.max(0, Math.min(1, rawP));
            const p = easeInOut(rawP);

            applySplashFX(p);

            // Toggle Fish Visibility removed (handled in loop)
            // water.classList.toggle('fish-on', p > 0.25);



            // Micro-Shake
            if (p > 0.45 && p < 0.7) document.body.classList.add('failure');
            else document.body.classList.remove('failure');

            if (p < 0.2) {
                setZone("MONITORING", "NORMAL", "#FFF");
                water.style.height = (p * 100) + '%';
                globalRain = 30; resetProps(); resetSink();
            } else if (p < 0.45) {
                // Set seen flag early
                if (!localStorage.getItem('floodzy_seen')) localStorage.setItem('floodzy_seen', 'yes');

                setZone("WARNING", "RISING", "#FFD60A");
                water.style.height = (p * 120) + '%';
                fence.classList.add('shaking'); globalRain = 60; resetProps();
            } else if (p < 0.70) {
                setZone("CRITICAL", "FAILURE", "#FF3B30");
                water.style.height = '90%'; globalRain = 100;
                fence.className = 'scenery-obj fence-drift'; tree.className = 'scenery-obj tree-fall';
                chars.forEach((c, i) => setTimeout(() => c.classList.add('drowning'), i * 100));
            } else if (p < 0.90) {
                setZone("DEPLOYMENT", "RESCUE", "#2EF2FF");
                water.style.height = '80%'; globalRain = 50;
                cord.style.top = '0'; drone.style.top = '50%';
            } else {
                setZone("SYSTEM", "INTERVENTION", "#2EF2FF");
                grid.style.opacity = 0.8;
                water.style.height = '40%';
                emergeSink(); // Staggered resurface
                drone.style.top = '-100px'; cord.style.top = '-100px';
            }
            syncFishCanvas(false);
        }

        function setZone(z, s, c) {
            hud.innerText = `ZONE: ${z}`;
            status.innerText = s;
            status.style.color = c;
            if (z === "CRITICAL") status.classList.add('disaster');
            else status.classList.remove('disaster');
        }
        function resetSink() { chars.forEach(c => { c.classList.remove('drowning'); c.classList.remove('resurfacing'); }); }

        function emergeSink() {
            chars.forEach((c, i) => {
                if (c.classList.contains('drowning')) {
                    c.classList.remove('drowning');
                    c.classList.add('resurfacing');
                    c.style.animationDelay = (i * 0.1) + 's';

                    // SYNC: Burst bubbles under the letter
                    const rect = c.getBoundingClientRect();
                    setTimeout(() => {
                        spawnBubbleBurst(rect.left + rect.width / 2, 6);
                    }, i * 100);

                    setTimeout(() => c.classList.remove('resurfacing'), 2000);
                }
            });
        }
        function resetProps() { fence.className = 'scenery-obj'; tree.className = 'scenery-obj'; }

        // Sunrise
        const sunSection = document.getElementById('final-sunrise');
        const sunOrb = document.querySelector('.sun-orb');
        const network = document.querySelector('.final-network');
        const obs = new IntersectionObserver(e => {
            if (e[0].isIntersecting) {
                sunOrb.classList.add('rise');
                network.style.opacity = 1;
                rainCanvas.style.opacity = 0;
            } else {
                rainCanvas.style.opacity = 1;
            }
        }, { threshold: 0.5 });
        obs.observe(sunSection);

        // Playground
        const playground = document.querySelector('.playground-container');
        if (playground) {
            playground.addEventListener('mouseenter', () => document.body.classList.add('sentinel-active'));
            playground.addEventListener('mouseleave', () => document.body.classList.remove('sentinel-active'));
        }

        // Sim Map Logic
        const map = document.getElementById('sim-map');
        const sensorCount = document.getElementById('sensor-count');
        const nodes = [];
        for (let i = 0; i < 12; i++) {
            let n = document.createElement('div');
            let type = Math.random() > 0.5 ? 'RIVER' : 'RAIN';
            n.className = 'node pulse'; n.dataset.type = type;
            n.style.left = (10 + Math.random() * 80) + '%'; n.style.top = (10 + Math.random() * 80) + '%';
            n.style.animationDelay = Math.random() + 's';
            map.appendChild(n); nodes.push(n);
        }

        const rainSlider = document.getElementById('rain-slider');
        const riverSlider = document.getElementById('river-slider');
        const riverLabel = document.getElementById('river-val');

        rainSlider.addEventListener('input', (e) => {
            document.getElementById('rain-val').innerText = e.target.value + '%';
            setTimeout(() => {
                const val = parseInt(e.target.value); globalRain = val;
                nodes.forEach(n => { if (n.dataset.type === 'RAIN' && val > 50 && Math.random() > 0.6) { n.classList.add('ripple'); setTimeout(() => n.classList.remove('ripple'), 1000); } });
            }, 100);
        });

        riverSlider.addEventListener('input', (e) => {
            setTimeout(() => {
                const val = parseInt(e.target.value);
                let status = "SAFE", colorClass = "", activeSensors = 12;
                if (val < 40) { status = "SAFE"; colorClass = ""; }
                else if (val < 80) { status = "WARNING"; colorClass = "warning"; }
                else { status = "CRITICAL"; colorClass = "critical"; activeSensors = Math.floor(12 * 0.6); }

                riverLabel.innerText = status;
                riverLabel.className = 'mono ' + (status === 'SAFE' ? 'text-cyan' : (status === 'WARNING' ? 'text-warning' : 'text-red'));
                sensorCount.innerText = activeSensors;

                nodes.forEach(n => {
                    n.className = 'node ' + colorClass;
                    if (status === 'CRITICAL') n.classList.add('critical'); else n.classList.add('pulse');
                });
            }, 150);
        });

        // === FINAL SAFE VISIBILITY CHECK ===


        document.addEventListener('visibilitychange', () => {
            isPageVisible = document.visibilityState === 'visible';

            if (!shouldAnimate()) {
                stopRain(); stopWave(); stopFx(); stopFish(); stopCursor();
                return;
            }

            if (isPageVisible) {
                startRain();
                startWave();
                startFx();
                startFish();
                startCursor();
            } else {
                stopRain();
                stopWave();
                stopFx();
                stopFish();
                stopCursor();
            }
        });

        reduceMotionMQ.addEventListener('change', () => {
            if (shouldAnimate()) { startRain(); startWave(); startFx(); startFish(); }
            else { stopRain(); stopWave(); stopFx(); stopFish(); stopCursor(); }
        });
    </script>
</body>

</html>